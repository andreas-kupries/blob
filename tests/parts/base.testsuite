## -*- tcl -*-
## (c) 2013 Andreas Kupries
# # ## ### ##### ######## ############# #####################
## Test suite for blob stores, common parts across implementations.
#
## The external procedures 'already' and 'badmethod' are used to
## generate implementation specific error messages. Implementations
## have to be provided by the invoking implementation-specific
## testsuite.
#
## The external procedures 'new-store' and 'release-store' are used to
## create and destroy an instance of the store under test.

# ------------*----------------
# dispatch    | *
# destroy     | *
# ------------*----------------
# add         | *
# channel     | *
# clear       | *
# delete      | *
# exists      | *
# names       | *
# put         | *
# retrieve    | *
# size        | *
# ------------*----------------

# # ## ### ##### ######## ############# #####################
## dispatch

test [test-class]-dispatch-1.0 {instance, no method} -setup {
    new-store
} -body {
    test-store
} -cleanup {
    release-store
} -returnCodes error \
    -result {wrong # args: should be "test-store method ?arg ...?"}

test [test-class]-dispatch-1.1 {instance, bad method name} -setup {
    new-store
} -body {
    test-store foo
} -cleanup {
    release-store
} -returnCodes error \
    -result [badmethod foo {add channel clear delete destroy exists names put retrieve size}]

# # ## ### ##### ######## ############# #####################
## destructor

test [test-class]-destroy-1.0 {destroy, wrong#args, too many} -setup {
    new-store
} -body {
    test-store destroy X
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store destroy"}

test [test-class]-destroy-1.1 {destroy} -setup {
    new-store
} -body {
    release-store
    info commands ::test-store
} -result {}

# # ## ### ##### ######## ############# #####################
## add

test [test-class]-add-1.0 {add, wrong#args, not enough} -setup {
    new-store
} -body {
    test-store add
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store add blob"}

test [test-class]-add-1.1 {add, wrong#args, too many} -setup {
    new-store
} -body {
    test-store add S X
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store add blob"}

test [test-class]-add-1.2 {add} -setup {
    new-store
} -body {
    test-store add S
} -cleanup {
    release-store
} -result 02aa629c8b16cd17a44f3a0efec2feed43937642

test [test-class]-add-1.3 {add, duplicates have same uuid} -setup {
    new-store
} -body {
    list [test-store add S] [test-store add S]
} -cleanup {
    release-store
} -result {02aa629c8b16cd17a44f3a0efec2feed43937642 02aa629c8b16cd17a44f3a0efec2feed43937642}

test [test-class]-add-1.4 {add, different blobs, different uuids} -setup {
    new-store
} -body {
    list [test-store add S] [test-store add S2]
} -cleanup {
    release-store
} -result {02aa629c8b16cd17a44f3a0efec2feed43937642 474c9bc027ee3ef22851a5f8bfd976f08b197386}

# # ## ### ##### ######## ############# #####################
## channel

test [test-class]-channel-1.0 {channel, wrong#args, not enough} -setup {
    new-store
} -body {
    test-store channel
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store channel uuid"}

test [test-class]-channel-1.1 {channel, wrong#args, too many} -setup {
    new-store
} -body {
    test-store channel S X
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store channel uuid"}

test [test-class]-channel-1.2 {channel, unknown uuid} -setup {
    new-store
} -body {
    test-store channel 0
} -cleanup {
    release-store
} -returnCodes error -result {Expected uuid, got "0"}

test [test-class]-channel-1.3 {channel, known} -setup {
    new-store
    test-store add S
} -body {
    set c [test-store channel 02aa629c8b16cd17a44f3a0efec2feed43937642]
    read $c
} -cleanup {
    close $c
    unset c
    release-store
} -result S

test [test-class]-channel-1.4 {channel, known} -setup {
    new-store
    test-store add S
    test-store add A
    test-store add R
    test-store add C
} -body {
    set c [test-store channel 06576556d1ad802f247cad11ae748be47b70cd9c]
    read $c
} -cleanup {
    close $c
    unset c
    release-store
} -result R

# # ## ### ##### ######## ############# #####################
## clear

test [test-class]-clear-1.0 {clear, wrong#args, too many} -setup {
    new-store
} -body {
    test-store clear S
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store clear"}

test [test-class]-clear-1.1 {clear, none} -setup {
    new-store
} -body {
    list [test-store size] [test-store clear] [test-store size]
} -cleanup {
    release-store
} -result {0 {} 0}

test [test-class]-clear-1.2 {clear, some} -setup {
    new-store
    test-store add S
    test-store add A
    test-store add R
    test-store add C
} -body {
    list [test-store size] [test-store clear] [test-store size]
} -cleanup {
    release-store
} -result {4 {} 0}

# # ## ### ##### ######## ############# #####################
## delete

test [test-class]-delete-1.0 {delete, wrong#args, not enough} -setup {
    new-store
} -body {
    test-store delete
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store delete uuid"}

test [test-class]-delete-1.1 {delete, wrong#args, too many} -setup {
    new-store
} -body {
    test-store delete S X
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store delete uuid"}

test [test-class]-delete-1.2 {delete, unknown} -setup {
    new-store
} -body {
    test-store delete S
} -cleanup {
    release-store
} -result {}

test [test-class]-delete-1.3 {delete, known} -setup {
    new-store
    test-store add S
} -body {
    test-store delete 02aa629c8b16cd17a44f3a0efec2feed43937642
} -cleanup {
    release-store
} -result {}

# # ## ### ##### ######## ############# #####################
## exists

test [test-class]-exists-1.0 {exists, wrong#args, not enough} -setup {
    new-store
} -body {
    test-store exists
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store exists uuid"}

test [test-class]-exists-1.1 {exists, wrong#args, too many} -setup {
    new-store
} -body {
    test-store exists S X
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store exists uuid"}

test [test-class]-exists-1.2 {exists, no} -setup {
    new-store
} -body {
    test-store exists S
} -cleanup {
    release-store
} -result 0

test [test-class]-exists-1.3 {exists, yes} -setup {
    new-store
    test-store add S
} -body {
    test-store exists 02aa629c8b16cd17a44f3a0efec2feed43937642
} -cleanup {
    release-store
} -result 1

# # ## ### ##### ######## ############# #####################
## names

test [test-class]-names-1.0 {names, wrong#args, too many} -setup {
    new-store
} -body {
    test-store names S
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store names"}

test [test-class]-names-1.1 {names, none} -setup {
    new-store
} -body {
    test-store names
} -cleanup {
    release-store
} -result {}

test [test-class]-names-1.2 {names, some} -setup {
    new-store
    test-store add S
    test-store add A
    test-store add R
    test-store add C
} -body {
    lsort [test-store names]
} -cleanup {
    release-store
} -result {02aa629c8b16cd17a44f3a0efec2feed43937642 06576556d1ad802f247cad11ae748be47b70cd9c 32096c2e0eff33d844ee6d675407ace18289357d 6dcd4ce23d88e2ee9568ba546c007c63d9131c1b}

# # ## ### ##### ######## ############# #####################
## put

test [test-class]-put-1.0 {put, wrong#args, not enough} -setup {
    new-store
} -body {
    test-store put
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store put path"}

test [test-class]-put-1.1 {put, wrong#args, too many} -setup {
    new-store
} -body {
    test-store put S X
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store put path"}

test [test-class]-put-1.2 {put} -setup {
    new-store
} -body {
    test-store put data/empty
} -cleanup {
    release-store
} -result da39a3ee5e6b4b0d3255bfef95601890afd80709

test [test-class]-put-1.3 {put, duplicates have same uuid} -setup {
    new-store
} -body {
    list [test-store put data/empty] [test-store put data/empty]
} -cleanup {
    release-store
} -result {da39a3ee5e6b4b0d3255bfef95601890afd80709 da39a3ee5e6b4b0d3255bfef95601890afd80709}

test [test-class]-put-1.4 {put, different blobs, different uuids} -setup {
    new-store
} -body {
    list [test-store put data/empty] [test-store put data/echo]
} -cleanup {
    release-store
} -result {da39a3ee5e6b4b0d3255bfef95601890afd80709 d929c82d2ee727ccbea9c50c669a71075249899f}

# # ## ### ##### ######## ############# #####################
## retrieve

test [test-class]-retrieve-1.0 {retrieve, wrong#args, not enough} -setup {
    new-store
} -body {
    test-store retrieve
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store retrieve uuid"}

test [test-class]-retrieve-1.1 {retrieve, wrong#args, too many} -setup {
    new-store
} -body {
    test-store retrieve S X
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store retrieve uuid"}

test [test-class]-retrieve-1.2 {retrieve, unknown uuid} -setup {
    new-store
} -body {
    test-store retrieve 0
} -cleanup {
    release-store
} -returnCodes error -result {Expected uuid, got "0"}

test [test-class]-retrieve-1.3 {retrieve, known} -setup {
    new-store
    test-store add S
} -body {
    test-store retrieve 02aa629c8b16cd17a44f3a0efec2feed43937642
} -cleanup {
    release-store
} -result S

test [test-class]-retrieve-1.4 {retrieve, known} -setup {
    new-store
    test-store add S
    test-store add A
    test-store add R
    test-store add C
} -body {
    test-store retrieve 06576556d1ad802f247cad11ae748be47b70cd9c
} -cleanup {
    release-store
} -result R

# # ## ### ##### ######## ############# #####################
## size

test [test-class]-size-1.0 {size, wrong#args, too many} -setup {
    new-store
} -body {
    test-store size X
} -cleanup {
    release-store
} -returnCodes error -result {wrong # args: should be "test-store size"}

test [test-class]-size-1.1 {size} -setup {
    new-store
    test-store add A
} -body {
    test-store size
} -cleanup {
    release-store
} -result 1

test [test-class]-size-1.2 {size} -setup {
    new-store
    test-store add A
    test-store add B
} -body {
    test-store size
} -cleanup {
    release-store
} -result 2

# # ## ### ##### ######## ############# #####################
return
